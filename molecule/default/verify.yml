# SPDX-FileCopyrightText: 2020 Helmholtz Centre for Environmental Research (UFZ)
# SPDX-FileCopyrightText: 2020 Helmholtz-Zentrum Dresden - Rossendorf (HZDR)
#
# SPDX-License-Identifier: Apache-2.0

---
- name: Verify
  hosts: all
  tasks:
    - name: Gather package facts
      package_facts:
        manager: auto

    - name: Gather service facts
      service_facts:

    - name: Assert that docker is installed
      assert:
        that:
          - "'docker-ce' in ansible_facts.packages"

    - name: Assert that Docker systemd service is running
      assert:
        that:
          - "ansible_facts.services['docker.service'].state == 'running'"
          - "ansible_facts.services['docker.service'].status == 'enabled'"

    - name: Check that docker-machine is properly installed
      command:
        cmd: docker-machine version
      changed_when: false
      register: machine_version
      failed_when: "'0.16.2-gitlab.6' not in machine_version.stdout"

    - name: Assert that Gitlab-Runner is installed
      assert:
        that:
          - "'gitlab-runner' in ansible_facts.packages"

    - name: Assert that installed GitLab version is equal to the desired one
      assert:
        that:
          - "ansible_facts.packages['gitlab-runner'][0].version == gitlab_runner_version"
      when:
        - gitlab_runner_version is defined

    - name: Assert that ignition.json file was created
      stat:
        path: /etc/gitlab-runner/ignition.json
      register: ignition
      failed_when: not ignition.stat.isreg

    - name: Assert that SSH keypair was created
      stat:
        path: /etc/gitlab-runner/gitlab_runner_key
      register: ssh_key
      failed_when: not ssh_key.stat.isreg or ssh_key.stat.mode != "0600"
